service: auth-service

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    REGION: ${self:provider.region}

functions:
  - ${file(resources/lambda.yml)}

resources:
  - ${file(resources/iam_role.yml)}
  - ${file(resources/cognito.yml)}

  - Resources:
      ApiGatewayRestApi:
        Type: AWS::ApiGateway::RestApi
        Properties:
          Name: ${self:service}-api-${self:provider.stage}

      ApiAuthorizer:
        Type: AWS::ApiGateway::Authorizer
        Properties:
          Name: CognitoAuthorizer
          Type: COGNITO_USER_POOLS
          IdentitySource: method.request.header.Authorization
          RestApiId: !Ref ApiGatewayRestApi
          ProviderARNs:
            - !GetAtt CognitoUserPool.Arn

# Outputs should be at the root level, not inside resources
outputs:
  UserPoolId:
    Value: !Ref CognitoUserPool
    Export:
      Name: ${self:service}-UserPoolId-${self:provider.stage}

  UserPoolClientId:
    Value: !Ref CognitoUserPoolClient
    Export:
      Name: ${self:service}-UserPoolClientId-${self:provider.stage}

  ApiUrl:
    Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${self:provider.region}.amazonaws.com/${self:provider.stage}"
    Export:
      Name: ${self:service}-ApiUrl-${self:provider.stage}
